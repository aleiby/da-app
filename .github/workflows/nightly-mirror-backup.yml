name: Nightly mirror backup

on:
  workflow_dispatch: {}
  schedule:
    # GitHub cron is UTC. Run twice to cover DST, then gate to 04:00 Pacific.
    - cron: '0 11 * * *'
    - cron: '0 12 * * *'

permissions:
  contents: read

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Decide whether to run mirror now
        id: gate
        shell: bash
        run: |
          set -euo pipefail

          # Manual runs always execute
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run_mirror=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Scheduled runs only execute at 04:00 Pacific
          if [ "$(TZ=America/Los_Angeles date +%H)" = "04" ]; then
            echo "run_mirror=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_mirror=false" >> "$GITHUB_OUTPUT"
            echo "Not 4am Pacific right now; skipping mirror."
          fi

      - name: Checkout full history (all branches and tags)
        if: steps.gate.outputs.run_mirror == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Clear GitHub auth header so PAT is used
        if: steps.gate.outputs.run_mirror == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config --global --unset-all http.https://github.com/.extraheader || true

      - name: "Preflight: verify token can access backup repo"
        if: steps.gate.outputs.run_mirror == 'true'
        shell: bash
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
          TARGET_REPO: aleiby/da-app-backup
        run: |
          set -euo pipefail
          code="$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${MIRROR_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${TARGET_REPO}")"
          echo "GitHub API status for ${TARGET_REPO}: ${code}"
          test "${code}" = "200"

      - name: True mirror-push to backup repo
        if: steps.gate.outputs.run_mirror == 'true'
        shell: bash
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
          TARGET_REPO: aleiby/da-app-backup
        run: |
          set -euo pipefail

          # Requires the fine-grained PAT to have:
          # - Contents: read/write
          # - Workflows: read/write
          git remote add backup "https://aleiby:${MIRROR_TOKEN}@github.com/${TARGET_REPO}.git"

          # Quick auth check
          git ls-remote backup >/dev/null

          # Mirror all refs (branches, tags, remote-tracking refs)
          git push --mirror backup
