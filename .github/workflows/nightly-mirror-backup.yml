name: Nightly mirror backup

on:
  schedule:
    # GitHub cron is UTC. Run twice to cover DST.
    - cron: "0 11 * * *"
    - cron: "0 12 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Decide whether to run mirror now
        id: gate
        run: |
          set -euo pipefail

          # Manual runs: always run
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run_mirror=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Scheduled runs: only run at 04:00 Pacific
          if [ "$(TZ=America/Los_Angeles date +%H)" = "04" ]; then
            echo "run_mirror=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_mirror=false" >> "$GITHUB_OUTPUT"
            echo "Not 4am Pacific right now; skipping mirror."
          fi

      - name: Checkout full history (all branches + tags)
        if: steps.gate.outputs.run_mirror == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Preflight: token can access backup repo
        if: steps.gate.outputs.run_mirror == 'true'
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
          TARGET_REPO: aleiby/da-app-backup
        run: |
          set -euo pipefail

          # This should be 200 if the token can see the private repo.
          code="$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${MIRROR_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${TARGET_REPO}")"

          echo "GitHub API status for ${TARGET_REPO}: ${code}"

          if [ "${code}" = "401" ]; then
            echo "ERROR: Token rejected (bad/expired token)."
            exit 1
          fi

          if [ "${code}" = "403" ]; then
            echo "ERROR: Token lacks required permissions or is blocked by a policy."
            exit 1
          fi

          if [ "${code}" = "404" ]; then
            echo "ERROR: Repo not found OR token cannot access it (common for private repos)."
            echo "Fix: ensure the fine-grained PAT is scoped to ${TARGET_REPO} and has Contents: read/write."
            exit 1
          fi

          if [ "${code}" != "200" ]; then
            echo "ERROR: Unexpected status ${code}."
            exit 1
          fi

          echo "Preflight OK."

      - name: Mirror-push to backup repo
        if: steps.gate.outputs.run_mirror == 'true'
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
          TARGET_REPO: aleiby/da-app-backup
        run: |
          set -euo pipefail
          git remote add backup "https://x-access-token:${MIRROR_TOKEN}@github.com/${TARGET_REPO}.git"
          git push --mirror backup
